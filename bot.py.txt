import asyncio
import datetime
import os
import aiosqlite
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

TOKEN = os.getenv("BOT_TOKEN")

bot = Bot(token=TOKEN)
dp = Dispatcher()

DB_NAME = "water.db"


async def init_db():
    async with aiosqlite.connect(DB_NAME) as db:
        await db.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            last_reminder DATE,
            last_drink DATE,
            streak INTEGER DEFAULT 0,
            total_days INTEGER DEFAULT 0
        )
        """)
        await db.commit()


def get_level(streak):
    if streak >= 30:
        return "üèÜ –ú–∞—à–∏–Ω–∞ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏"
    elif streak >= 21:
        return "üíé –ê–ª—Ö–∏–º–∏–∫ –≤–æ–¥—ã"
    elif streak >= 7:
        return "üî• –û—Å–æ–∑–Ω–∞–Ω–Ω—ã–π"
    else:
        return "üå± –ù–æ–≤–∏—á–æ–∫"


def drink_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üíß –í—ã–ø–∏–ª –≤–æ–¥—É", callback_data="drink")]
        ]
    )


async def check_and_remind(user_id):
    today = datetime.date.today()

    async with aiosqlite.connect(DB_NAME) as db:
        cursor = await db.execute(
            "SELECT last_reminder FROM users WHERE user_id = ?",
            (user_id,)
        )
        row = await cursor.fetchone()

        if row is None or row[0] != str(today):
            await bot.send_message(
                user_id,
                "üíß –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!\n–°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã = –∑–∞–ø—É—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ üöÄ",
                reply_markup=drink_keyboard()
            )

            await db.execute(
                "INSERT OR IGNORE INTO users (user_id) VALUES (?)",
                (user_id,)
            )
            await db.execute(
                "UPDATE users SET last_reminder = ? WHERE user_id = ?",
                (today, user_id)
            )
            await db.commit()


@dp.callback_query(lambda c: c.data == "drink")
async def drink(callback: types.CallbackQuery):
    today = datetime.date.today()

    async with aiosqlite.connect(DB_NAME) as db:
        cursor = await db.execute(
            "SELECT last_drink, streak, total_days FROM users WHERE user_id = ?",
            (callback.from_user.id,)
        )
        last_drink, streak, total_days = await cursor.fetchone()

        if last_drink == str(today):
            await callback.answer("–£–∂–µ –æ—Ç–º–µ—á–µ–Ω–æ üëç", show_alert=True)
            return

        if last_drink == str(today - datetime.timedelta(days=1)):
            streak += 1
        else:
            streak = 1

        total_days += 1

        await db.execute("""
            UPDATE users
            SET last_drink = ?, streak = ?, total_days = ?
            WHERE user_id = ?
        """, (today, streak, total_days, callback.from_user.id))
        await db.commit()

    await callback.message.answer(
        f"‚úÖ –û—Ç–ª–∏—á–Ω–æ!\nüî• –°–µ—Ä–∏—è: {streak}\nüèÖ –£—Ä–æ–≤–µ–Ω—å: {get_level(streak)}"
    )
    await callback.answer()


@dp.message(CommandStart())
async def start(message: types.Message):
    await message.answer(
        "–Ø –ø–æ–º–æ–≥—É –≤—ã—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É –ø–∏—Ç—å –≤–æ–¥—É üíß\n"
        "–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –Ω–∞–ø–æ–º–∏–Ω–∞—é –∏ –≤–µ–¥—É —Å–µ—Ä–∏—é üî•"
    )
    await check_and_remind(message.from_user.id)


@dp.message()
async def any_msg(message: types.Message):
    await check_and_remind(message.from_user.id)


async def main():
    await init_db()
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
